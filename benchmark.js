const OPEN_AI_KEY = "REPLACE_WITH_YOUR_OPEN_AI_KEY";
const prompt957TokenEcho = "Please reorganize the sentences in a long text into paragraphs by inserting line breaks. The text must remain exactly the same as the original text. ```If the reader will excuse me, I will say nothing of my antecedents, nor of the circumstances which led me to leave my native country; the narrative would be tedious to him and painful to myself. Suffice it, that when I left home it was with the intention of going to some new colony, and either finding, or even perhaps purchasing, waste crown land suitable for cattle or sheep farming, by which means I thought that I could better my fortunes more rapidly than in England. It will be seen that I did not succeed in my design, and that however much I may have met with that was new and strange, I have been unable to reap any pecuniary advantage. It is true, I imagine myself to have made a discovery which, if I can be the first to profit by it, will bring me a recompense beyond all money computation, and secure me a position such as has not been attained by more than some fifteen or sixteen persons, since the creation of the universe. But to this end I must possess myself of a considerable sum of money: neither do I know how to get it, except by interesting the public in my story, and inducing the charitable to come forward and assist me. With this hope I now publish my adventures; but I do so with great reluctance, for I fear that my story will be doubted unless I tell the whole of it; and yet I dare not do so, lest others with more means than mine should get the start of me. I prefer the risk of being doubted to that of being anticipated, and have therefore concealed my destination on leaving England, as also the point from which I began my more serious and difficult journey. My chief consolation lies in the fact that truth bears its own impress, and that my story will carry conviction by reason of the internal evidences for its accuracy. No one who is himself honest will doubt my being so. I reached my destination in one of the last months of 1868, but I dare not mention the season, lest the reader should gather in which hemisphere I was. The colony was one which had not been opened up even to the most adventurous settlers for more than eight or nine years, having been previously uninhabited, save by a few tribes of savages who frequented the seaboard. The part known to Europeans consisted of a coast-line about eight hundred miles in length (affording three or four good harbours), and a tract of country extending inland for a space varying from two to three hundred miles, until it a reached the offshoots of an exceedingly lofty range of mountains, which could be seen from far out upon the plains, and were covered with perpetual snow. The coast was perfectly well known both north and south of the tract to which I have alluded, but in neither direction was there a single harbour for five hundred miles, and the mountains, which descended almost into the sea, were covered with thick timber, so that none would think of settling. With this bay of land, however, the case was different. The harbours were sufficient; the country was timbered, but not too heavily; it was admirably suited for agriculture; it also contained millions on millions of acres of the most beautifully grassed country in the world, and of the best suited for all manner of sheep and cattle. The climate was temperate, and very healthy; there were no wild animals, nor were the natives dangerous, being few in number and of an intelligent tractable disposition. It may be readily understood that when once Europeans set foot upon this territory they were not slow to take advantage of its capabilities. Sheep and cattle were introduced, and bred with extreme rapidity; men took up their 50,000 or 100,000 acres of country, going inland one behind the other, till in a few years there was not an acre between the sea and the front ranges which was not taken up, and stations either for sheep or cattle were spotted about at intervals of some twenty or thirty miles over the whole country. The front ranges stopped the tide of squatters for some little time; it was thought that there was too much snow upon them for too many months in the year,–that the sheep would get lost, the ground being too difficult for shepherding,–that the expense of getting wool down to the ship’s side would eat up the farmer’s profits,–and that the grass was too rough and sour for sheep to thrive upon; but one after another determined to try the experiment, and it was wonderful how successfully it turned out.```";
const prompt1930TokenEcho = "Please reorganize the sentences in a long text into paragraphs by inserting line breaks. The text must remain exactly the same as the original text. ```If the reader will excuse me, I will say nothing of my antecedents, nor of the circumstances which led me to leave my native country; the narrative would be tedious to him and painful to myself. Suffice it, that when I left home it was with the intention of going to some new colony, and either finding, or even perhaps purchasing, waste crown land suitable for cattle or sheep farming, by which means I thought that I could better my fortunes more rapidly than in England. It will be seen that I did not succeed in my design, and that however much I may have met with that was new and strange, I have been unable to reap any pecuniary advantage. It is true, I imagine myself to have made a discovery which, if I can be the first to profit by it, will bring me a recompense beyond all money computation, and secure me a position such as has not been attained by more than some fifteen or sixteen persons, since the creation of the universe. But to this end I must possess myself of a considerable sum of money: neither do I know how to get it, except by interesting the public in my story, and inducing the charitable to come forward and assist me. With this hope I now publish my adventures; but I do so with great reluctance, for I fear that my story will be doubted unless I tell the whole of it; and yet I dare not do so, lest others with more means than mine should get the start of me. I prefer the risk of being doubted to that of being anticipated, and have therefore concealed my destination on leaving England, as also the point from which I began my more serious and difficult journey. My chief consolation lies in the fact that truth bears its own impress, and that my story will carry conviction by reason of the internal evidences for its accuracy. No one who is himself honest will doubt my being so. I reached my destination in one of the last months of 1868, but I dare not mention the season, lest the reader should gather in which hemisphere I was. The colony was one which had not been opened up even to the most adventurous settlers for more than eight or nine years, having been previously uninhabited, save by a few tribes of savages who frequented the seaboard. The part known to Europeans consisted of a coast-line about eight hundred miles in length (affording three or four good harbours), and a tract of country extending inland for a space varying from two to three hundred miles, until it a reached the offshoots of an exceedingly lofty range of mountains, which could be seen from far out upon the plains, and were covered with perpetual snow. The coast was perfectly well known both north and south of the tract to which I have alluded, but in neither direction was there a single harbour for five hundred miles, and the mountains, which descended almost into the sea, were covered with thick timber, so that none would think of settling. With this bay of land, however, the case was different. The harbours were sufficient; the country was timbered, but not too heavily; it was admirably suited for agriculture; it also contained millions on millions of acres of the most beautifully grassed country in the world, and of the best suited for all manner of sheep and cattle. The climate was temperate, and very healthy; there were no wild animals, nor were the natives dangerous, being few in number and of an intelligent tractable disposition. It may be readily understood that when once Europeans set foot upon this territory they were not slow to take advantage of its capabilities. Sheep and cattle were introduced, and bred with extreme rapidity; men took up their 50,000 or 100,000 acres of country, going inland one behind the other, till in a few years there was not an acre between the sea and the front ranges which was not taken up, and stations either for sheep or cattle were spotted about at intervals of some twenty or thirty miles over the whole country. The front ranges stopped the tide of squatters for some little time; it was thought that there was too much snow upon them for too many months in the year,—that the sheep would get lost, the ground being too difficult for shepherding,—that the expense of getting wool down to the ship’s side would eat up the farmer’s profits,—and that the grass was too rough and sour for sheep to thrive upon; but one after another determined to try the experiment, and it was wonderful how successfully it turned out. Men pushed farther and farther into the mountains, and found a very considerable tract inside the front range, between it and another which was loftier still, though even this was not the highest, the great snowy one which could be seen from out upon the plains. This second range, however, seemed to mark the extreme limits of pastoral country; and it was here, at a small and newly founded station, that I was received as a cadet, and soon regularly employed. I was then just twenty-two years old. I was delighted with the country and the manner of life. It was my daily business to go up to the top of a certain high mountain, and down one of its spurs on to the flat, in order to make sure that no sheep had crossed their boundaries. I was to see the sheep, not necessarily close at hand, nor to get them in a single mob, but to see enough of them here and there to feel easy that nothing had gone wrong; this was no difficult matter, for there were not above eight hundred of them; and, being all breeding ewes, they were pretty quiet. There were a good many sheep which I knew, as two or three black ewes, and a black lamb or two, and several others which had some distinguishing mark whereby I could tell them. I would try and see all these, and if they were all there, and the mob looked large enough, I might rest assured that all was well. It is surprising how soon the eye becomes accustomed to missing twenty sheep out of two or three hundred. I had a telescope and a dog, and would take bread and meat and tobacco with me. Starting with early dawn, it would be night before I could complete my round; for the mountain over which I had to go was very high. In winter it was covered with snow, and the sheep needed no watching from above. If I were to see sheep dung or tracks going down on to the other side of the mountain (where there was a valley with a stream—a mere cul de sac), I was to follow them, and look out for sheep; but I never saw any, the sheep always descending on to their own side, partly from habit, and partly because there was abundance of good sweet feed, which had been burnt in the early spring, just before I came, and was now deliciously green and rich, while that on the other side had never been burnt, and was rank and coarse. It was a monotonous life, but it was very healthy and one does not much mind anything when one is well. The country was the grandest that can be imagined. How often have I sat on the mountain side and watched the waving downs, with the two white specks of huts in the distance, and the little square of garden behind them; the paddock with a patch of bright green oats above the huts, and the yards and wool-sheds down on the flat below; all seen as through the wrong end of a telescope, so clear and brilliant was the air, or as upon a colossal model or map spread out beneath me. Beyond the downs was a plain, going down to a river of great size, on the farther side of which there were other high mountains, with the winter’s snow still not quite melted; up the river, which ran winding in many streams over a bed some two miles broad, I looked upon the second great chain, and could see a narrow gorge where the river retired and was lost. I knew that there was a range still farther back; but except from one place near the very top of my own mountain, no part of it was visible: from this point, however, I saw, whenever there were no clouds, a single snow-clad peak, many miles away, and I should think about as high as any mountain in the world. Never shall I forget the utter loneliness of the prospect—only the little far-away homestead giving sign of human handiwork;—the vastness of mountain and plain, of river and sky; the marvellous atmospheric effects—sometimes black mountains against a white sky, and then again, after cold weather, white mountains against a black sky—sometimes seen through breaks and swirls of cloud—and sometimes, which was best of all, I went up my mountain in a fog, and then got above the mist; going higher and higher, I would look down upon a sea of whiteness, through which would be thrust innumerable mountain tops that looked like islands. I am there now, as I write; I fancy that I can see the downs, the huts, the plain, and the river-bed—that torrent pathway of desolation, with its distant roar of waters. Oh, wonderful! wonderful!```";

export async function benchmarkOpenAiApi(requestCompletion = fetchOpenAiCompletion) {
  const prompt = prompt1930TokenEcho;
  const requests = Array(3).fill(0).map(async (_, index) => {
    const start = Date.now();
    const totalTokenUsed = await requestCompletion(prompt);
    const timeElapsed = Date.now() - start;
    console.log(`Request ${index} of ${totalTokenUsed} tokens took ${timeElapsed}ms`);
    return { totalTokenUsed, timeElapsed };
  });
  console.log(`Starting ${requests.length} requests`);
  const benchmarks = await Promise.allSettled(requests);
  const successfulBenchmarks = benchmarks.filter((b) => b.status === 'fulfilled').map((b) => b.value);
  console.log(`Successful completed ${successfulBenchmarks.length} requests. Latencies: ${successfulBenchmarks.map((b) => b.timeElapsed).join(', ')}`);
  console.log(`Median request latency: ${median(successfulBenchmarks.map((b) => b.timeElapsed))}ms`);
  return benchmarks;
}

function median(array) {
  const length = array.length;
  if (length === 0) {
    return undefined;
  }
  const sorted = [...array].sort();
  if (length % 2 !== 0) {
    return sorted[(length - 1) / 2];
  } else {
    return (sorted[length / 2 - 1] + sorted[length / 2]) / 2;
  }
}

export async function fetchOpenAiCompletion(prompt) {
  const result = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${OPEN_AI_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'gpt-3.5-turbo',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.0,
      max_tokens: 2000,
    }),
  });
  if (result.status !== 200) {
    throw Error(`OpenAI request failed with status ${result.status} : ${result.statusText}`);
  }
  const data = await result.json();
  const response = data.choices[0].message.content;
  console.log(`OpenAiResponse: ${response.substring(0, 10)}...(${response.length - 10} chars)`);
  return data.usage.total_tokens;
}
